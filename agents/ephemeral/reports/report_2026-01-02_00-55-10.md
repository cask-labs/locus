# Difficulty Report: ProvisioningWorker Implementation

**Date:** 2026-01-02 00:55:10
**Task:** 07-provisioning-worker-plan.md

## 1. The "Tink vs. Robolectric" KeyStore Conflict

### Problem Description
The `ProvisioningWorker` depends on `AuthRepository`, which relies on `SecureStorageDataSource`. This data source is configured to use Google Tink for encryption, specifically initializing `AndroidKeysetManager` with a master key URI of `android-keystore://master_key`.

When running unit tests with Robolectric (annotated with `@Config(sdk = [34])`), the test environment fails to fully emulate the Android Keystore in the way Tink expects. This resulted in the following exception chain during the initialization of the `LocusApp` (which happens automatically because of `@HiltAndroidTest` or even standard Robolectric setup scanning the Manifest):
*   `java.lang.IllegalStateException` at `AndroidKeystoreKmsClient.java`
*   Caused by: `java.security.KeyStoreException`
*   Caused by: `java.security.NoSuchAlgorithmException`

This crash occurred during the Hilt dependency graph creation, effectively blocking any test execution before the test method logic could even run.

### Failed Solutions
1.  **Mocking the Repository:** I initially attempted to mock `AuthRepository` in the test. However, this failed because Hilt constructs the *entire* singleton component graph for the Application (including the real `EncryptionModule` which provides the `Aead` primitive) before it injects the test class. Therefore, the crash happened during the graph build, rendering the mock irrelevant to the initialization failure.
2.  **Using `TinkConfig.register()`:** I verified that `TinkConfig.register()` was called in `LocusApp`, but this only registers standard primitives and does not fix the underlying platform issue of the missing/incompatible KeyStore in the simulated environment.

### Successful Solution
I implemented a **Module Replacement** strategy using Hilt's testing features:
1.  Created a `DummyAead` class that implements the `Aead` interface but performs no-op (or simple pass-through) encryption, avoiding any interaction with the Android KeyStore.
2.  Created a `TestEncryptionModule` in the test source set (`app/src/test/kotlin/com/locus/android/di/TestEncryptionModule.kt`).
3.  Annotated this module with `@TestInstallIn(components = [SingletonComponent::class], replaces = [EncryptionModule::class])`.
4.  Configured the test class with `@HiltAndroidTest` and used `HiltTestApplication` as the application class in the `@Config` annotation.

This forced Hilt to use the `DummyAead` during tests, bypassing the problematic `EncryptionModule` entirely while keeping the production code secure.

## 2. Dependency Injection Gaps

### Problem Description
During compilation, the build failed with `[Dagger/MissingBinding]` errors for:
1.  `androidx.work.WorkManager`
2.  `com.locus.core.domain.util.TimeProvider`

These dependencies were required by the `ProvisioningWorker` and `AuthRepositoryImpl` but were not explicitly provided in any Hilt module.

### Successful Solution
1.  Created `core/data/src/main/kotlin/com/locus/core/data/di/WorkManagerModule.kt` to provide the `WorkManager` instance (`WorkManager.getInstance(context)`).
2.  Updated `core/data/src/main/kotlin/com/locus/core/data/di/DataModule.kt` to bind the `DefaultTimeProvider` implementation to the `TimeProvider` interface using `@Binds`.

## 3. Android 14 Foreground Service Compliance

### Problem Description
The `ProvisioningWorker` correctly defined its foreground service type as `dataSync` in the code (`ServiceInfo.FOREGROUND_SERVICE_TYPE_DATA_SYNC`). However, simply defining the type in code and the `service` entry in `AndroidManifest.xml` is insufficient for Android 14 (API 34). The system enforces strict permission checks.

Running the app (or properly simulated tests) would result in a `SecurityException` because the specific permissions were missing.

### Successful Solution
I explicitly added the following permissions to `app/src/main/AndroidManifest.xml`:
*   `<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />` (Base permission for Android 9+)
*   `<uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />` (Specific permission for Android 14+)

## 4. Test Compilation & Configuration

### Problem Description
I encountered several compilation errors in the test files:
1.  `AuthError` references were ambiguous or missing correct nesting (needed `DomainException.AuthError`).
2.  `BootstrapCredentials` constructor signature in tests did not match the production code (missing `region`).
3.  `ProvisioningState.Failure` matching in tests required correct exception instantiation.

### Successful Solution
I iteratively fixed the imports, updated the `BootstrapCredentials` instantiation to include `"us-east-1"`, and corrected the `Truth` assertions and `Mockk` verifications to match the specific sealed class hierarchy of `DomainException`.
