# Gap Analysis Report: Task 10 Permissions & Setup Trap

**Status:** Gaps Identified
**Date:** 2026-01-04
**Source:** `agents/ephemeral/phase1-onboarding/10-permissions-setup-trap-plan.md`

## Findings

### 1. Architecture Violation: Permission Checking Mechanism
*   **Gap:** The plan states in Step 4: *"Observe ON_RESUME to trigger viewModel.checkPermissions()"*. This implies the ViewModel performs the permission check. However, `ContextCompat.checkSelfPermission` requires a `Context`, which ViewModels should not hold to prevent memory leaks and testing issues.
*   **Analysis:** The logic for *checking* permissions belongs in the UI (Composable) using `LocalContext` or Activity context. The logic for *deciding what to do next* (State Machine) belongs in the ViewModel.
*   **Resolution:** The plan must clarify that the UI performs the check (e.g., in `onResume`) and passes the result map (or boolean flags) to a ViewModel method like `updatePermissionsState(hasFine: Boolean, hasCoarse: Boolean, ...)`.

### 2. Missing "Coarse Rejection" UI Specification
*   **Gap:** The plan mandates *"Enforce ACCESS_FINE_LOCATION. Treat Coarse Only as a denial"*. However, the plan does not specify *how* the UI should communicate this specific failure state to the user.
*   **Analysis:** Simply treating it as "denied" might leave the user confused if they just clicked "Approximate" in the system dialog. The UI needs a specific feedback loop (e.g., an error message or specific rationale text) explaining that "Precise location is required for tracking."
*   **Resolution:** Add a requirement for the ViewModel to expose a specific error state (e.g., `PermissionUiState.CoarseOnlyError`) and for the UI to display a specific rationale message when this state is active.

### 3. Service Stub Implementation Detail
*   **Gap:** The plan instructs to *"Create TrackerService (Stub if missing)"*. A standard empty Service will likely crash or be killed immediately if promoted to a Foreground Service without a valid Notification and Channel (Android 8+ requirement).
*   **Analysis:** To satisfy the goal of "Services start immediately," the stub must be a functional implementation of the Foreground Service pattern (creating a NotificationChannel and calling `startForeground` in `onStartCommand`), even if it performs no actual tracking logic.
*   **Resolution:** Explicitly require the stub to implement the minimum viable Foreground Service lifecycle (Notification + `startForeground`) to ensure process stability during the transition test.

### 4. Implicit Refactoring Instructions
*   **Gap:** Step 4 says *"Refactor PermissionScreen to use PermissionViewModel"* but does not explicitly instruct to remove the existing internal state (`currentStep`, `determinePermissionStep`) and logic.
*   **Analysis:** This ambiguity often leads to "zombie code" where the old logic is commented out or left alongside the new pattern, confusing future maintainers.
*   **Resolution:** Explicitly include an instruction to *remove* the legacy internal state management from `PermissionScreen` as part of the refactor.

### 5. Testing Naming Convention
*   **Gap:** Step 9 instructs to *"Create PermissionViewModelTest.kt"* but does not reiterate the strict project rule regarding test function naming.
*   **Analysis:** Project memory mandates strict adherence to the Kotlin backtick syntax (e.g., \`returns failure when...\`) for test names.
*   **Resolution:** Add a note to Step 9 to ensure test function names follow the required backtick convention.

### 6. ViewModel Context for Service Start
*   **Gap:** The plan updates `MainActivity` to invoke `StartTrackingUseCase`. While acceptable, the analysis considered if `MainViewModel` should handle this. However, since `StartTrackingUseCase` likely starts a Service (requiring Context), `MainActivity` is the correct place for the trigger.
*   **Resolution:** No change needed, but confirmed that `MainActivity` using `LaunchedEffect` to call an injected UseCase is the valid pattern here given the Service requirement.

## Proposed Resolution

We recommend updating the implementation plan or simply executing with these clarifications in mind. No changes to the original plan file are requested by the user, only this report.

## Technical Details for Implementation

*   **Manifest:** Add `ACCESS_FINE_LOCATION`, `ACCESS_COARSE_LOCATION`, `ACCESS_BACKGROUND_LOCATION`, `FOREGROUND_SERVICE_LOCATION`, `POST_NOTIFICATIONS`.
*   **AuthRepository:** Add self-healing logic in `initialize`: `if (authState == Authenticated && onboardingStage != COMPLETE) { onboardingStage = PERMISSIONS_PENDING }`.
*   **PermissionViewModel:** Implement `updatePermissions(fine, coarse, background, notification)` instead of `checkPermissions()`.
*   **TrackerService:** Ensure `onStartCommand` builds a valid Notification and calls `startForeground`.
