# Gap Analysis Report: Task 10 Permissions & Setup Trap

**Analyzed Plan:** `agents/ephemeral/phase1-onboarding/10-permissions-setup-trap-plan.md`
**Timestamp:** 20260104_225210

## 1. Permission Checking Mechanism (Architecture Violation)
**Problem:** The plan states: *"Lifecycle: Observe ON_RESUME to trigger viewModel.checkPermissions()"*.
**Analysis:** `PermissionViewModel` should not hold a `Context` reference, which is required for `ContextCompat.checkSelfPermission`. Delegating permission checks directly to the ViewModel violates Android architecture principles and makes the ViewModel difficult to test and prone to memory leaks.
**Resolution:** The plan must clarify that the **UI (Composable)** is responsible for performing the permission check (using `LocalContext`) and passing the result (e.g., `Map<String, Boolean>`) to the ViewModel via a method like `viewModel.updatePermissionStatus(permissions)`. The ViewModel then derives the UI state.

## 2. "Coarse Only" Denial Feedback Loop
**Problem:** The plan mandates *"Enforce ACCESS_FINE_LOCATION. Treat Coarse Only as a denial"*.
**Analysis:** The current `PermissionScreen` implementation accepts `ACCESS_COARSE_LOCATION` as a success condition. While the plan correctly identifies the need to change this, it lacks specific instructions on how the UI should communicate this new "Soft Denial" state to the user. Simply keeping the user on the same screen might be confusing without specific error messaging (e.g., "Precise location is required for tracking").
**Resolution:** The `PermissionUiState` should include a specific error/feedback state for "Coarse Granted, Fine Denied" to trigger a Snackbar or specific rationale text in the UI explaining why precise location is mandatory.

## 3. Tracker Service Stub Functionality
**Problem:** The plan instructs to *"Create TrackerService.kt (Stub if missing)"*.
**Analysis:** A bare minimum stub will crash on Android 14 if it doesn't immediately call `startForeground` with a valid notification and channel. To satisfy the goal of "Services start immediately," the stub must be functional enough to promote itself to a Foreground Service and display a notification, even if it performs no actual tracking logic yet.
**Resolution:** Explicitly require the stub to implement `onStartCommand` with `startForeground` using a valid Notification Channel to prevent runtime crashes and validate the service start flow.

## 4. Explicit Removal of Legacy Code
**Problem:** The plan instructions say *"Refactor PermissionScreen to use PermissionViewModel"*.
**Analysis:** The current `PermissionScreen.kt` contains significant internal state management (`currentStep`, `determinePermissionStep`) and logic. The plan does not explicitly instruct the removal of this legacy code, which poses a risk of leaving "zombie code" or conflicting logic within the Composable.
**Resolution:** Add an explicit instruction to remove the internal `PermissionStep` enum and logic from `PermissionScreen.kt`, fully delegating state to `PermissionViewModel`.

## 5. Testing Naming Conventions
**Problem:** The plan step for testing (`Create PermissionViewModelTest.kt`) does not specify naming conventions.
**Analysis:** Project rules (`AGENTS.md` memory) strictly prefer Kotlin backtick syntax with spaces for test function names.
**Resolution:** Add a reminder to strictly adhere to the backtick naming convention (e.g., `` `returns failure when...` ``) in the testing step.

## 6. Notification Permission Optionality
**Problem:** The plan states *"Mark as Optional: Proceed even if denied"*.
**Analysis:** The current `PermissionScreen` logic forces a rationale loop if permissions are denied. The refactored logic must explicitly branch: `ACCESS_FINE_LOCATION` denial -> Block/Rationale, whereas `POST_NOTIFICATIONS` denial -> Proceed.
**Resolution:** Ensure the `PermissionViewModel` logic treats `POST_NOTIFICATIONS` as a non-blocking permission.

## 7. Service Trigger Location
**Problem:** The plan places the service trigger in `MainActivity` via `LaunchedEffect`.
**Analysis:** While valid, `MainActivity` is a view container. The trigger relies on `StartTrackingUseCase`. Ensure the UseCase is correctly injected into `MainActivity` (via Hilt) or that the trigger logic is encapsulated cleanly.
**Resolution:** Confirming that injecting `StartTrackingUseCase` into `MainActivity` is the intended approach for this "Application Entry" logic. No change needed, but noted for verification.
