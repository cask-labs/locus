# Deep Analysis Report: 08-task-8-plan.md

**Date:** 2026-01-02
**Target:** `agents/ephemeral/phase1-onboarding/08-task-8-plan.md`

## Problem 1: Missing "Setup Trap" and State Restoration Logic

**Finding:**
The plan fails to implement the critical "Setup Trap" mechanism required by the Onboarding Specification. The `OnboardingViewModel` logic is limited to `pasteJson` and `validateCredentials`, completely omitting the initialization logic needed to check the user's current status (e.g., `Provisioning`, `PermissionsPending`) and route them to the correct screen.

**Deep Analysis:**
`docs/technical_discovery/specs/ui/onboarding.md` (Section 2 & R1.1900) explicitly mandates that the system must "restore the last known provisioning state" if the app is killed and relaunched. It describes a "State Machine Persister" that detects flags like `PROVISIONING_STARTED` or `PERMISSIONS_PENDING` to bypass the Welcome screen. The current plan does not account for reading this state on initialization.

**Resolution:**
Update Phase 1 (Logic) of the plan to include an `init` block or `checkState()` function in `OnboardingViewModel`. This function must query `AuthRepository` (or `SecureStorage`) upon creation to determine if the user is in a "trapped" state and emit a `NavigationEvent` to route immediately to the `Provisioning` or `Permission` screen.

## Problem 2: Incomplete Navigation Flow and Missing Destination

**Finding:**
The plan defines the goal as implementing the "Onboarding flow", but it stops abruptly at the `CredentialEntryScreen`. The `validateCredentials` function is tested to "trigger navigation," but the destination (`ChoiceScreen`) is neither created nor stubbed.

**Deep Analysis:**
`docs/technical_discovery/specs/ui/onboarding.md` (Section 1) defines the flow as `Welcome -> Credentials -> Choice -> ...`. Without the `ChoiceScreen` (or a defined destination), the `validateCredentials` success path leads nowhere. Implementing navigation logic that points to a non-existent route will cause runtime crashes or compilation errors in the navigation graph construction.

**Resolution:**
Update Phase 2 of the plan to include a step to create a basic **Stub** for the `ChoiceScreen`. This ensures the navigation graph is valid and the "Success" path of the credential entry has a concrete, compilable destination.

## Problem 3: Integration Gap in `MainActivity` (Start Destination)

**Finding:**
The plan instructs to "Add OnboardingGraph to the main NavHost" but does not define the logic for *selecting* the `OnboardingGraph` as the start destination based on authentication state.

**Deep Analysis:**
`docs/behavioral_specs/01_onboarding_identity.md` (R1.1900) and general Android navigation principles require a conditional start destination. Simply adding a graph to `MainActivity` does not make it visible if the default start destination is set to `Dashboard`. The system needs logic to observe `AuthRepository.state` (Uninitialized/SetupPending vs Authenticated) to decide whether to show the Onboarding flow or the Dashboard.

**Resolution:**
Update Phase 3 of the plan to include a step to implement the "Start Destination Logic" in `MainActivity` (or a `MainViewModel`). This logic must determine the initial route based on the repository state.

## Problem 4: Missing Mandatory Pre-Commit Step Description

**Finding:**
The plan lacks the strictly mandated `pre_commit_instructions` step description in the format required by the `AGENTS.md` rules.

**Deep Analysis:**
The system rules state: "You must include a pre-commit step in your plan... describe the steps purpose, which is to 'ensure proper testing, verification, review, and reflection are done'." The current Phase 3 mentions running tests but does not follow the specific protocol required for agent reliability and compliance with the `AGENTS.md` directive.

**Resolution:**
Update the plan to include a distinct step: "4. *Complete pre commit steps*" with the exact description: "Complete pre commit steps to ensure proper testing, verification, review, and reflection are done."

## Problem 5: Missing Layout Constraints (Landscape/Tablet)

**Finding:**
The plan does not mention the specific layout requirements for tablet/landscape support defined in the specs.

**Deep Analysis:**
`docs/technical_discovery/specs/ui/onboarding.md` (Section 1) strictly mandates: "Landscape/Tablet: Use a Scrollable Column layout centered on the screen with a maximum width (e.g., 600dp)." Ignoring this during the "Create visual components" phase creates technical debt and violates the UI specification, leading to a poor user experience on larger devices.

**Resolution:**
Update Phase 2 steps in the plan to explicitly mention wrapping screen content in a constrained layout container that respects the max-width/centering rules for landscape support.
