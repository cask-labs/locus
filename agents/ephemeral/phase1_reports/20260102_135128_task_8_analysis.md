# Analysis Report: Onboarding Task 8 Plan

**Target:** `agents/ephemeral/phase1-onboarding/08-task-8-plan.md`
**Date:** Fri Jan  2 13:51:28 UTC 2026

## Executive Summary
A deep analysis of the Task 8 plan reveals critical gaps in state management, navigation flow, and adherence to specific UI/UX constraints mandated by the specifications. Five (5) specific problems were identified.

## Findings

### Problem 1: Missing "Setup Trap" and State Restoration Logic
*   **Finding:** The plan fails to implement the "Setup Trap" mechanism. The `OnboardingViewModel` logic is limited to credential validation and lacks the initialization logic to check the user's current provisioning status (e.g., `Provisioning`, `PermissionsPending`) and route them accordingly.
*   **Supporting Documentation:** `docs/technical_discovery/specs/ui/onboarding.md` (Section 2) explicitly mandates a "State Machine Persister" to detect flags like `PROVISIONING_STARTED` and bypass the Welcome screen upon relaunch. `docs/behavioral_specs/01_onboarding_identity.md` (**R1.1900**) reinforces that the system must restore the last known state.
*   **Resolution:** Update Phase 1 of the plan to include a `checkState()` function or `init` block in `OnboardingViewModel`. This function must query `AuthRepository` to determine if the user is in a "trapped" state and trigger an immediate navigation event.

### Problem 2: Incomplete Navigation Flow (Missing Choice Screen)
*   **Finding:** The plan defines the goal as implementing the "Onboarding flow" but stops at `CredentialEntryScreen`. The `validateCredentials` success path has no defined destination, as the `ChoiceScreen` is neither created nor stubbed.
*   **Supporting Documentation:** `docs/technical_discovery/specs/ui/onboarding.md` (Section 1) defines the flow as `Welcome -> Credentials -> Choice`. Without the `ChoiceScreen`, the validation success logic cannot be effectively implemented or tested.
*   **Resolution:** Update Phase 2 of the plan to include the creation of a **Stub** for the `ChoiceScreen` (and `ProvisioningScreen`) to ensure the navigation graph is valid and the `validateCredentials` logic has a concrete destination.

### Problem 3: Integration Gap in MainActivity (Start Destination Logic)
*   **Finding:** The plan instructs to add the `OnboardingGraph` to `MainActivity` but does not define the logic for *selecting* it as the start destination versus the `Dashboard`.
*   **Supporting Documentation:** `docs/behavioral_specs/01_onboarding_identity.md` (Bounded Context) implies the system cannot function until identity is established. The `MainActivity` needs logic to observe `AuthRepository.state` (Uninitialized/SetupPending vs Authenticated) to decide which graph to load.
*   **Resolution:** Update Phase 3 to explicitly include implementing "Start Destination Logic" in `MainActivity` (or a `MainViewModel`) that checks `AuthRepository` to conditionally set the `startDestination` of the `NavHost`.

### Problem 4: Missing Mandatory Pre-Commit Step Description
*   **Finding:** The plan lacks the specific pre-commit step description required by the agent rules.
*   **Supporting Documentation:** The System Prompt ("Planning" section) mandates: "You must include a pre-commit step... describe the steps purpose, which is to 'ensure proper testing, verification, review, and reflection are done'."
*   **Resolution:** Add a distinct step "4. Complete pre commit steps" to the plan with the exact required description.

### Problem 5: Missing Layout Constraints (Tablet/Landscape)
*   **Finding:** The plan does not mention the specific layout requirements for tablet/landscape support.
*   **Supporting Documentation:** `docs/technical_discovery/specs/ui/onboarding.md` (Section 1) strictly mandates: "Landscape/Tablet: Use a Scrollable Column layout centered on the screen with a maximum width (e.g., 600dp)."
*   **Resolution:** Update Phase 2 steps to explicitly mention wrapping screen content in a constrained layout container that respects the max-width and centering rules.
