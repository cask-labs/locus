AWSTemplateFormatVersion: '2010-09-09'
Description: 'Locus: User-Owned Precision Tracker - S3 Bucket with Object Lock'

# Architecture Notes:
# - Per-Device Isolation: Each device installation creates one IAM User with isolated credentials
# - Key Swap Pattern: Bootstrap keys (CloudFormation only) are replaced with runtime keys (S3-only) after stack creation
# - Object Lock Governance: Allows per-device override if needed; tracks have 100-year retention set by application
# - S3 Access Logging: Enabled for audit trail; logs stored in same bucket under logs/s3-access/ prefix
# - Lifecycle Policies: Diagnostics and access logs expire after 30 days; tracks retain per application-set headers (100 years)
# See: docs/adr/iam-policy-attachment-per-device-isolation.md for policy attachment design
# See: docs/technical_discovery/infrastructure.md for full architecture details

Parameters:
  StackName:
    Type: String
    Description: A unique name for your device/installation (e.g., Pixel7, MyPhone).
    AllowedPattern: "^[a-zA-Z0-9]+$"
    ConstraintDescription: Must be alphanumeric only.

Resources:
  LocusDataBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      # We let CloudFormation generate a unique name to avoid collisions.

      VersioningConfiguration:
        Status: Enabled

      ObjectLockEnabled: true

      ObjectLockConfiguration:
        ObjectLockEnabled: 'Enabled'
        # DefaultRetention is intentionally omitted.
        # The Application is responsible for setting the Retention Header for Track data.
        # This allows Diagnostics data to be deleted by Lifecycle policies.

      LifecycleConfiguration:
        Rules:
          - Id: ExpireDiagnostics
            Status: Enabled
            Prefix: diagnostics/
            ExpirationInDays: 30
          - Id: ExpireS3AccessLogs
            Status: Enabled
            Prefix: logs/s3-access/
            ExpirationInDays: 30

      # Tagging for Admin/ABAC Support
      # Allows Admin users to target "Locus Buckets" specifically via ResourceTag conditions
      Tags:
        - Key: LocusRole
          Value: DeviceBucket

      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

      # S3 Access Logging: Audit trail of bucket access
      # Logs are stored in the same bucket under logs/s3-access/ prefix
      # Expired after 30 days via lifecycle policy (see below)
      LoggingConfiguration:
        DestinationBucketName: !Ref LocusDataBucket
        LogFilePrefix: logs/s3-access/

  # Runtime User: One per device for isolated credentials
  # Policy is attached directly to this user (not via group/role)
  # See: docs/adr/iam-policy-attachment-per-device-isolation.md
  LocusUser:
    Type: AWS::IAM::User
    Properties:
      UserName: !Sub "locus-user-${StackName}"
      Tags:
        - Key: LocusRole
          Value: DeviceUser

  LocusAccessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      UserName: !Ref LocusUser

  # Runtime Credentials Policy: Least-privilege S3-only access
  # Attached directly to LocusUser (one per device isolation model)
  # Actions limited to: PutObject, GetObject, ListBucket on this bucket only
  # Note: CKV_AWS_40 (attach to groups/roles) is intentionally not followed here
  # because per-device isolation uses direct user attachment, not group sharing.
  # Suppressed in verify_security.sh - see docs/adr/iam-policy-attachment-per-device-isolation.md
  LocusPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub "locus-policy-${StackName}"
      Users:
        - !Ref LocusUser
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !Sub "arn:aws:s3:::${LocusDataBucket}"
              - !Sub "arn:aws:s3:::${LocusDataBucket}/*"

Outputs:
  BucketName:
    Description: 'The name of the created S3 bucket'
    Value: !Ref LocusDataBucket
  BucketArn:
    Description: 'The ARN of the created S3 bucket'
    Value: !GetAtt LocusDataBucket.Arn
  AccessKeyId:
    Description: 'Runtime Access Key ID'
    Value: !Ref LocusAccessKey
  SecretAccessKey:
    Description: 'Runtime Secret Access Key'
    Value: !GetAtt LocusAccessKey.SecretAccessKey
